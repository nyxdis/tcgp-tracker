{% extends "tracker/base.html" %} {% load static %} {% block content %}
<div class="container mt-5">
  <h2>{{ set.name }}</h2>
  <p>Erscheinungsdatum: {{ set.release_date }}</p>

  <div class="mb-3 text-end">
    <button id="collect-base-btn" class="btn btn-success">Alle Basiskarten sammeln</button>
  </div>

  <table class="table table-hover mt-4">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Rarity</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for card in cards %}
      <tr
        class="clickable-row"
        data-card-id="{{ card.id }}"
        data-action="{% if card.collected_quantity > 0 %}uncollect{% else %}collect{% endif %}"
        data-rarity="{{ card.rarity.name }}"
      >
        <td>{{ card.number }}</td>
        <td>{{ card.name }}</td>
        <td>
          {% for _ in ""|center:card.rarity.repeat_count %}
          <img src="{% static 'tracker/img/'|add:card.rarity.image_name %}" alt="{{ card.rarity.display_name }}" width="24" height="24" />
          {% endfor %}
        </td>
        <td class="status-cell">{% if card.collected_quantity > 0 %} ✅ {% else %} ❌ {% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="mt-4 text-center">
    <a href="{% url 'home' %}" class="btn btn-outline-primary">← Zur&uuml;ck</a>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const rows = document.querySelectorAll(".clickable-row");

    rows.forEach((row) => {
      row.addEventListener("click", function () {
        const cardId = row.dataset.cardId;
        const action = row.dataset.action;

        fetch("", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: new URLSearchParams({
            card_id: cardId,
            action: action,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            // Update the row's status cell and action
            const statusCell = row.querySelector(".status-cell");
            if (data.collected) {
              statusCell.textContent = "✅";
              row.dataset.action = "uncollect";
            } else {
              statusCell.textContent = "❌";
              row.dataset.action = "collect";
            }
          });
      });
    });

    // Collect all common/uncommon/rare/double_rare cards
    document.getElementById("collect-base-btn").addEventListener("click", function () {
      const rarities = ["common", "uncommon", "rare", "double_rare"];
      const csrfToken = "{{ csrf_token }}";
      rows.forEach((row) => {
        const rarity = row.dataset.rarity;
        if (rarities.includes(rarity) && row.dataset.action === "collect") {
          const cardId = row.dataset.cardId;
          fetch("", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrfToken,
              "X-Requested-With": "XMLHttpRequest",
            },
            body: new URLSearchParams({
              card_id: cardId,
              action: "collect",
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              const statusCell = row.querySelector(".status-cell");
              if (data.collected) {
                statusCell.textContent = "✅";
                row.dataset.action = "uncollect";
              }
            });
        }
      });
    });
  });
</script>
{% endblock %}
