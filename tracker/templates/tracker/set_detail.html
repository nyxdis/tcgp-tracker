{% extends "tracker/base.html" %}
{% load i18n %}
{% load static %}
{% block style %}
  <style>
  .highlight {
    --bs-table-bg: lightyellow;
    transition: background-color 0.5s ease;
  }

  #scroll-to-top-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: none;
    z-index: 1000;
  }

  .sortable {
    cursor: pointer;
  }
  .sortable:hover {
    text-decoration: underline;
  }

  .clickable-row {
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .clickable-row:hover,
  .clickable-row:focus {
    background-color: #e6f2ff !important;
    outline: 2px solid #339af0;
  }

  @media (min-width: 576px) {
    .d-flex.flex-sm-row .btn.w-100.w-sm-auto {
      width: auto !important;
      min-width: 180px;
    }
    .d-flex.flex-sm-row .btn.flex-sm-shrink-0 {
      flex-shrink: 0 !important;
    }
    .d-flex.flex-sm-row .d-flex.flex-sm-row {
      width: auto !important;
      flex-grow: 0 !important;
    }
  }
  </style>
{% endblock style %}
{% block title %}
  {{ set.name }} - Pokémon TCG Pocket Tracker
{% endblock title %}
{% block content %}
  <h2>{{ set.name }}</h2>
  <p>{% trans "Release Date" %}: {{ set.release_date }}</p>
  <div class="mb-3 d-flex flex-column flex-sm-row justify-content-between align-items-stretch gap-2">
    <a href="{% url 'home' %}"
       class="btn btn-outline-primary w-100 w-sm-auto">← {% trans "Back" %}</a>
    <div class="d-flex flex-row gap-2 flex-grow-1 flex-sm-grow-0">
      <button id="collect-base-btn"
              class="btn btn-success w-100 w-sm-auto flex-sm-shrink-0">{% trans "Collect all base cards" %}</button>
      <button id="jump-to-illustration-rare-btn"
              class="btn btn-info w-100 w-sm-auto flex-sm-shrink-0"
              title="Springe zur ersten Illustration Rare Karte">
        <span class="me-1">{% trans "Jump to" %}</span>
        <img src="{% static 'tracker/img/rare.webp' %}"
             alt="Illustration Rare"
             width="24"
             height="24" />
        <span>{% trans " cards" %}</span>
      </button>
    </div>
  </div>
  <!-- Filter Input -->
  <div class="mb-3">
    <input type="text"
           id="table-filter"
           class="form-control"
           placeholder="{% trans "Search for name or number" %}..."
           autocomplete="off"
           inputmode="search"
           autocorrect="off"
           autocapitalize="off"
           spellcheck="false" />
  </div>
  <table class="table table-hover mt-4">
    <thead>
      <tr>
        <th class="sortable" data-sort="number">
          #
          <span class="sort-arrow" data-key="number"></span>
        </th>
        <th class="sortable" data-sort="name">
          {% trans "Name" %}
          <span class="sort-arrow" data-key="name"></span>
        </th>
        <th class="sortable" data-sort="rarity">
          {% trans "Rarity" %}
          <span class="sort-arrow" data-key="rarity"></span>
        </th>
        <th class="sortable" data-sort="status">
          {% trans "Status" %}
          <span class="sort-arrow" data-key="status"></span>
        </th>
      </tr>
    </thead>
    <tbody>
      {% for card in cards %}
        <tr class="clickable-row"
            data-card-id="{{ card.id }}"
            data-action="{% if card.collected_quantity > 0 %}uncollect{% else %}collect{% endif %}"
            data-rarity="{{ card.rarity.name }}">
          <td>{{ card.number }}</td>
          <td>{{ card.name }}</td>
          <td>
            {% for _ in ""|center:card.rarity.repeat_count %}
              <img src="{% static 'tracker/img/'|add:card.rarity.image_name %}"
                   alt="{{ card.rarity.display_name }}"
                   width="24"
                   height="24" />
            {% endfor %}
          </td>
          <td class="status-cell">
            {% if card.collected_quantity > 0 %}
              ✅
            {% else %}
              ❌
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="mt-4 text-center">
    <a href="{% url 'home' %}" class="btn btn-outline-primary">← {% trans "Back" %}</a>
  </div>
  <!-- Floating Button -->
  <button id="scroll-to-top-btn" class="btn btn-primary">⬆</button>
  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const rows = document.querySelectorAll(".clickable-row");
    const filterInput = document.getElementById("table-filter");
    const table = document.querySelector("table");
    const headers = table.querySelectorAll("th.sortable");
    let sortDirection = {};

    // Initial sort by card number (ascending)
    (function initialSortByNumber() {
      const tbody = table.querySelector("tbody");
      const rowArr = Array.from(tbody.querySelectorAll("tr"));
      rowArr.sort((a, b) => {
        const aVal = parseInt(a.children[0].textContent.trim()) || 0;
        const bVal = parseInt(b.children[0].textContent.trim()) || 0;
        return aVal - bVal;
      });
      rowArr.forEach((row) => tbody.appendChild(row));
      // Set arrow for number column
      const numberHeader = Array.from(headers).find((h) => h.dataset.sort === "number");
      if (numberHeader) {
        const arrowSpan = numberHeader.querySelector(".sort-arrow");
        if (arrowSpan) arrowSpan.textContent = "▲";
        sortDirection["number"] = "asc";
      }
    })();

    headers.forEach((header, idx) => {
      header.addEventListener("click", function () {
        const sortKey = header.dataset.sort;
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const dir = sortDirection[sortKey] === "asc" ? "desc" : "asc";
        sortDirection[sortKey] = dir;

        // Remove all arrows
        document.querySelectorAll(".sort-arrow").forEach((span) => {
          span.textContent = "";
        });

        // Set arrow for current header
        const arrowSpan = header.querySelector(".sort-arrow");
        arrowSpan.textContent = dir === "asc" ? "▲" : "▼";

        rows.sort((a, b) => {
          let aVal, bVal;
          if (sortKey === "number") {
            aVal = parseInt(a.children[0].textContent.trim()) || 0;
            bVal = parseInt(b.children[0].textContent.trim()) || 0;
          } else if (sortKey === "name") {
            aVal = a.children[1].textContent.trim().toLowerCase();
            bVal = b.children[1].textContent.trim().toLowerCase();
          } else if (sortKey === "rarity") {
            aVal = a.dataset.rarity || "";
            bVal = b.dataset.rarity || "";
          } else if (sortKey === "status") {
            aVal = a.querySelector(".status-cell").textContent.trim();
            bVal = b.querySelector(".status-cell").textContent.trim();
          }
          if (aVal < bVal) return dir === "asc" ? -1 : 1;
          if (aVal > bVal) return dir === "asc" ? 1 : -1;
          return 0;
        });

        rows.forEach((row) => tbody.appendChild(row));
      });
    });

    // Filter table rows based on input
    filterInput.addEventListener("input", function () {
      const filterValue = filterInput.value.toLowerCase();
      rows.forEach((row) => {
        const cells = Array.from(row.querySelectorAll("td"));
        const rowText = cells.map((cell) => cell.textContent.toLowerCase()).join(" ");
        if (rowText.includes(filterValue)) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    });

    rows.forEach((row) => {
      row.addEventListener("click", function () {
        const cardId = row.dataset.cardId;
        const action = row.dataset.action;

        fetch("", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: new URLSearchParams({
            card_id: cardId,
            action: action,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            const statusCell = row.querySelector(".status-cell");
            if (data.collected) {
              statusCell.textContent = "✅";
              row.dataset.action = "uncollect";
            } else {
              statusCell.textContent = "❌";
              row.dataset.action = "collect";
            }
          });
      });
    });

    document.getElementById("collect-base-btn").addEventListener("click", function () {
      const rarities = ["common", "uncommon", "rare", "double_rare"];
      const csrfToken = "{{ csrf_token }}";
      rows.forEach((row) => {
        const rarity = row.dataset.rarity;
        if (rarities.includes(rarity) && row.dataset.action === "collect") {
          const cardId = row.dataset.cardId;
          fetch("", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrfToken,
              "X-Requested-With": "XMLHttpRequest",
            },
            body: new URLSearchParams({
              card_id: cardId,
              action: "collect",
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              const statusCell = row.querySelector(".status-cell");
              if (data.collected) {
                statusCell.textContent = "✅";
                row.dataset.action = "uncollect";
              }
            });
        }
      });
    });

    document.getElementById("jump-to-illustration-rare-btn").addEventListener("click", function () {
      const illustrationRareRow = Array.from(rows).find((row) => row.dataset.rarity === "illustration_rare");
      if (illustrationRareRow) {
        illustrationRareRow.scrollIntoView({ behavior: "smooth", block: "center" });
        illustrationRareRow.classList.add("highlight");
        setTimeout(() => illustrationRareRow.classList.remove("highlight"), 2000);
      }
    });

    const scrollToTopBtn = document.getElementById("scroll-to-top-btn");
    scrollToTopBtn.addEventListener("click", function () {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    window.addEventListener("scroll", function () {
      if (window.scrollY > 200) {
        scrollToTopBtn.style.display = "block";
      } else {
        scrollToTopBtn.style.display = "none";
      }
    });
  });
  </script>
{% endblock content %}
